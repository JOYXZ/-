<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AI è¥å…»å¸ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
        #chat::-webkit-scrollbar { width: 4px; }
        #chat::-webkit-scrollbar-thumb { background: #e5e7eb; border-radius: 10px; }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        .msg-animation {
            animation: fadeIn 0.3s ease-out forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* å¾®ä¿¡é£æ ¼å®‰å…¨åŒºåŸŸé€‚é… */
        body { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="bg-[#F3F4F6] h-screen flex flex-col overflow-hidden text-gray-800">

    <header class="h-14 flex items-center justify-center border-b bg-white font-bold text-lg tracking-wide shadow-sm shrink-0">
        ğŸ¥¦ AI ä¸“ä¸šè¥å…»å¸ˆ
    </header>

    <main id="chat" class="flex-1 overflow-y-auto p-4 space-y-4">
        <div class="msg-animation flex items-start">
            <div class="bg-white px-4 py-2 border rounded-2xl rounded-tl-none shadow-sm max-w-[85%]">
                ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„ç§äººè¥å…»å¸ˆã€‚æ‹ä¸‹é£Ÿå“æ ‡ç­¾ï¼Œæˆ‘ä¸ºä½ æ·±åº¦è§£æå¥åº·ç¨‹åº¦ã€‚
            </div>
        </div>
    </main>

    <div id="preview-container" class="px-4 hidden">
        <div class="relative inline-block">
            <img id="preview" class="h-20 w-20 object-cover rounded-lg border-2 border-white shadow-md">
            <button onclick="clearImage()" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 text-xs flex items-center justify-center">Ã—</button>
        </div>
    </div>

    <footer class="glass-effect p-3 border-t">
        <div class="max-w-4xl mx-auto flex items-end gap-2">
            <label class="flex items-center justify-center w-12 h-12 shrink-0 bg-white border border-gray-200 rounded-full cursor-pointer active:scale-90 transition-transform shadow-sm">
                <span class="text-2xl">ğŸ“·</span>
                <input type="file" id="fileInput" hidden accept="image/*" onchange="handleFile()">
            </label>
            
            <div class="flex-1 relative">
                <textarea id="userInput" rows="1" 
                    class="w-full bg-white border border-gray-200 rounded-2xl px-4 py-3 outline-none focus:ring-2 focus:ring-green-400 transition-all resize-none text-base"
                    placeholder="è¾“å…¥é—®é¢˜æˆ–ç›´æ¥æ‹æ‘„æ ‡ç­¾..."
                    oninput="this.style.height='auto';this.style.height=this.scrollHeight+'px'"></textarea>
            </div>

            <button id="sendBtn" onclick="sendMessage()" 
                class="w-12 h-12 shrink-0 bg-green-500 hover:bg-green-600 text-white rounded-full flex items-center justify-center shadow-lg active:scale-90 transition-all">
                <svg viewBox="0 0 24 24" class="w-6 h-6 fill-current"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>
            </button>
        </div>
    </footer>

    <script>
        const API_KEY = 'sk-6f30d07d56ad422ab4f9c515c3e19aff'; 
        const API_URL = 'https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions';
        let currentBase64 = "";

        function handleFile() {
            const file = document.getElementById('fileInput').files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onloadend = () => {
                currentBase64 = reader.result.split(',')[1];
                document.getElementById('preview').src = reader.result;
                document.getElementById('preview-container').classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }

        function clearImage() {
            currentBase64 = "";
            document.getElementById('preview-container').classList.add('hidden');
            document.getElementById('fileInput').value = "";
        }

        function appendMessage(role, content) {
            const chat = document.getElementById('chat');
            const wrapper = document.createElement('div');
            wrapper.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'} msg-animation`;
            
            const htmlContent = role === 'bot' ? marked.parse(content) : content;
            const bgColor = role === 'user' ? 'bg-green-500 text-white rounded-tr-none' : 'bg-white border rounded-tl-none shadow-sm';
            
            wrapper.innerHTML = `<div class="${bgColor} px-4 py-2 rounded-2xl max-w-[85%] text-[16px] leading-relaxed">${htmlContent}</div>`;
            chat.appendChild(wrapper);
            chat.scrollTop = chat.scrollHeight;
            return wrapper;
        }

        async function sendMessage() {
            const input = document.getElementById('userInput');
            const text = input.value.trim();
            if (!text && !currentBase64) return;

            const userText = text || (currentBase64 ? "ğŸ” æ­£åœ¨åˆ†æè¿™å¼ é£Ÿå“æ ‡ç­¾..." : "");
            appendMessage('user', userText);

            // æ„é€ è¯·æ±‚
            const content = [{ type: "text", text: text || "è¯·å¸®æˆ‘è¯¦ç»†åˆ†æè¿™å¼ é£Ÿç‰©æ ‡ç­¾ã€‚" }];
            if (currentBase64) {
                content.push({ type: "image_url", image_url: { url: `data:image/jpeg;base64,${currentBase64}` } });
            }

            // é‡ç½®ç•Œé¢
            input.value = "";
            input.style.height = 'auto';
            clearImage();

            // æ˜¾ç¤ºåŠ è½½ä¸­
            const loadingMsg = appendMessage('bot', '<div class="flex space-x-2"><div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div><div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay:0.2s"></div><div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay:0.4s"></div></div>');

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${API_KEY}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: "qwen-vl-plus",
                        messages: [
                            { role: "system", content: "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è¥å…»å¸ˆã€‚è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ‰§è¡Œä»»åŠ¡ï¼š1.åˆ†æè¥å…»æˆåˆ† 2.è¯†åˆ«ç…§ç‰‡æ ‡ç­¾ 3.æ·±åº¦åˆ†ææ•°æ® 4.è¯´æ˜å¥åº·ç¨‹åº¦ 5.åˆ—ä¸¾ä¼˜ç¼ºç‚¹ 6.ç»¼åˆæ‰“åˆ†ã€‚è¯·ç”¨æ’ç‰ˆç²¾ç¾çš„ Markdown æ ¼å¼å›ç­”ã€‚" },
                            { role: "user", content: content }
                        ]
                    })
                });
                const data = await response.json();
                loadingMsg.innerHTML = `<div class="bg-white px-4 py-2 border rounded-2xl rounded-tl-none shadow-sm max-w-[85%]">${marked.parse(data.choices[0].message.content)}</div>`;
            } catch (e) {
                loadingMsg.innerHTML = `<div class="bg-white px-4 py-2 border rounded-2xl rounded-tl-none shadow-sm max-w-[85%] text-red-500">è¿æ¥è¶…æ—¶ï¼Œè¯·é‡è¯•ã€‚</div>`;
            }
            chat.scrollTop = chat.scrollHeight;
        }
    </script>
</body>
</html>
