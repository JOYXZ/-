<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI é£Ÿç‰©æ ‡ç­¾è¯†åˆ«</title>
    <style>
        :root { --primary: #07c160; }
        body { font-family: -apple-system, system-ui, sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; background: #f2f2f2; }
        #chat { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; }
        .msg { margin-bottom: 15px; padding: 12px 16px; border-radius: 12px; max-width: 85%; line-height: 1.6; font-size: 16px; word-wrap: break-word; }
        .user { align-self: flex-end; background: var(--primary); color: white; border-top-right-radius: 2px; }
        .bot { align-self: flex-start; background: white; color: #333; border-top-left-radius: 2px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .input-area { background: #f7f7f7; padding: 10px 15px; display: flex; align-items: center; border-top: 0.5px solid #ddd; padding-bottom: calc(10px + env(safe-area-inset-bottom)); }
        input[type="text"] { flex: 1; border: none; padding: 10px 15px; border-radius: 8px; outline: none; font-size: 16px; background: white; }
        .upload-btn { background: none; border: none; font-size: 24px; padding: 0 10px; cursor: pointer; display: flex; align-items: center; }
        button#send { background: var(--primary); color: white; border: none; padding: 8px 18px; border-radius: 6px; margin-left: 10px; font-weight: 500; }
        #preview-container { padding: 0 15px; background: #f2f2f2; }
        #preview { max-width: 80px; display: none; border-radius: 4px; border: 1px solid #ccc; margin-top: 5px; }
    </style>
</head>
<body>
    <div id="chat">
        <div class="msg bot">ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„å¥åº·åŠ©æ‰‹ã€‚ç‚¹å‡»å·¦ä¾§å›¾æ ‡æ‹ç…§ä¸Šä¼ é£Ÿç‰©æ ‡ç­¾ï¼Œæˆ‘ä¼šå¸®ä½ åˆ†ææˆåˆ†ã€‚</div>
    </div>
    <div id="preview-container"><img id="preview"></div>
    <div class="input-area">
        <label class="upload-btn">
            ğŸ“·<input type="file" id="fileInput" hidden accept="image/*" onchange="handleFile()">
        </label>
        <input type="text" id="userInput" placeholder="é—®é—®æˆåˆ†æˆ–ç›´æ¥ç‚¹å‘é€...">
        <button id="send" onclick="sendMessage()">å‘é€</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        const API_KEY = 'sk-6f30d07d56ad422ab4f9c515c3e19aff'; 
        const API_URL = 'https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions';
        let currentBase64 = "";

        function handleFile() {
            const file = document.getElementById('fileInput').files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onloadend = () => {
                currentBase64 = reader.result.split(',')[1];
                const preview = document.getElementById('preview');
                preview.src = reader.result;
                preview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        async function sendMessage() {
            const input = document.getElementById('userInput');
            const chat = document.getElementById('chat');
            const text = input.value || (currentBase64 ? "è¯·å¸®æˆ‘è¯†åˆ«è¿™å¼ å›¾é‡Œçš„é£Ÿç‰©æ ‡ç­¾å†…å®¹" : "");
            
            if (!text && !currentBase64) return;

            // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
            const userDiv = document.createElement('div');
            userDiv.className = 'msg user';
            userDiv.textContent = text + (currentBase64 ? " [å›¾ç‰‡]" : "");
            chat.appendChild(userDiv);
            
            // æ„é€  AI è¯·æ±‚
            const content = [{ type: "text", text: text }];
            if (currentBase64) {
                content.push({ type: "image_url", image_url: { url: `data:image/jpeg;base64,${currentBase64}` } });
            }

            // æ¸…ç†è¾“å…¥æ¡†å’Œé¢„è§ˆ
            // æ„é€  AI è¯·æ±‚ï¼šåŠ å…¥ä½ å®šåˆ¶çš„ 6 ç‚¹ä¸“ä¸šè¥å…»å¸ˆæŒ‡ä»¤
            const bodyData = {
                model: "qwen-vl-plus",
                messages: [
                    { 
                        role: "system", 
                        content: `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è¥å…»å¸ˆã€‚è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ‰§è¡Œä»»åŠ¡ï¼š
1. åˆ†æç”¨æˆ·è´­ä¹°é£Ÿå“çš„è¥å…»æˆåˆ†ï¼›
2. è¯†åˆ«ç”¨æˆ·æ‹æ‘„ç…§ç‰‡ä¸­çš„é£Ÿå“æ ‡ç­¾ï¼ˆæˆåˆ†è¡¨ã€è¥å…»æˆåˆ†è¡¨ç­‰ï¼‰ï¼›
3. åŸºäºè¯†åˆ«åˆ°çš„æ ‡ç­¾æ•°æ®è¿›è¡Œæ·±åº¦åˆ†æï¼›
4. é€šè¿‡åˆ†ææˆåˆ†è¡¨ï¼ˆå¦‚æ·»åŠ å‰‚ã€ç³–ã€é’ ã€æ²¹è„‚ç­‰ï¼‰ï¼Œæ˜ç¡®å‘Šè¯‰ç”¨æˆ·è¯¥é£Ÿå“çš„å¥åº·ç¨‹åº¦ï¼›
5. è¯¦ç»†åˆ—å‡ºè¯¥é£Ÿå“çš„ä¼˜ç‚¹ï¼ˆå¦‚é«˜è›‹ç™½ã€æ— æ·»åŠ ç­‰ï¼‰å’Œç¼ºç‚¹ï¼ˆå¦‚é«˜çƒ­é‡ã€åå¼è„‚è‚ªç­‰ï¼‰ï¼›
6. æœ€åï¼Œè¯·ä¸ºè¯¥é£Ÿå“è¿›è¡Œç»¼åˆæ‰“åˆ†ï¼ˆæ»¡åˆ†ä¸º10åˆ†ï¼‰ã€‚
è¯·ä½¿ç”¨æ¸…æ™°çš„æ ‡é¢˜æˆ–åˆ—è¡¨æ ¼å¼è¾“å‡ºï¼Œç¡®ä¿å›ç­”ä¸“ä¸šã€æ˜“æ‡‚ä¸”å…·æœ‰æŒ‡å¯¼æ„ä¹‰ã€‚` 
                    },
                    { 
                        role: "user", 
                        content: content 
                    }
                ]
            };
            currentBase64 = ""; 

            // æ˜¾ç¤ºâ€œæ€è€ƒä¸­...â€
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'msg bot';
            loadingDiv.textContent = "æ­£åœ¨è¯†åˆ«åˆ†æï¼Œè¯·ç¨å€™...";
            chat.appendChild(loadingDiv);
            chat.scrollTop = chat.scrollHeight;

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(bodyData)
                });
                const data = await response.json();
                const result = data.choices[0].message.content;
                loadingDiv.innerHTML = marked.parse(result);
            } catch (e) {
                loadingDiv.textContent = "å‡ºé”™å•¦ï¼Œè¯·æ£€æŸ¥ API é¢åº¦æˆ–ç½‘ç»œè®¾ç½®ã€‚";
            }
            chat.scrollTop = chat.scrollHeight;
        }
    </script>
</body>
</html>
